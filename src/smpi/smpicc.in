#!/bin/bash
#FIXME: .. paths...
prefix="@prefix@"
exec_prefix="@exec_prefix@"

CC="gcc"

SEED="221238"

TMPDIR="$(mktemp -d tmpXXXXXXX)"

function modsource {
  SOURCE="$1"
  SOURCEFILE="$(basename ${SOURCE})"
  SOURCEDIR="${SOURCE%${SOURCEFILE}}"
  if [ -n "${SOURCEDIR}" ]; then
    mkdir -p ${TMPDIR}${SOURCEDIR}
  fi
  TMPSOURCE="${TMPDIR}${SOURCE}"
  cat > ${TMPSOURCE} <<HEADER
#define SEED ${SEED}
#include "smpi/smpi.h"
#include "xbt/sysdep.h"
#include "xbt/log.h"
#include "xbt/asserts.h"
#define sleep(x) smpi_sleep(x)
#define gettimeofday(x, y) smpi_gettimeofday(x, y)
int smpi_run_simulation(int *argc, char **argv);
HEADER
  # very simplistic transform, will probably want full parser for next version
  grep -v "mpi.h" < ${SOURCE} | perl -pe 's/main/smpi_simulated_main/;' >> ${TMPSOURCE}
  grep -q "smpi_simulated_main" ${TMPSOURCE}
  if [ $? -eq 0 ]; then
    cat >> ${TMPSOURCE} <<FOOTER
int main(int argc, char **argv) {
    return smpi_run_simulation(&argc, argv);
}
FOOTER
  fi
}

INCLUDEARGS="-I @top_srcdir@/include "
LINKARGS="-L@top_builddir@/src/.libs -L@libdir@ -lsimgrid -lsmpi "

CMDLINE=""
while [ -n "$1" ]; do
  ARG="$1"
  shift
  if [ "${ARG}" = "-c" ]; then
      LINKARGS=""
      CMDLINE="${CMDLINE} -c "
  elif [ "${ARG%.c}" != "${ARG}" ]; then
    INCLUDEARGS="${INCLUDEARGS} -I . -I .. -I ../include -I @includedir@ "
    SRCFILE="$(realpath ${ARG})"
    modsource ${SRCFILE}
    CMDLINE="${CMDLINE} ${TMPDIR}${SRCFILE} "
  else
    CMDLINE="${CMDLINE} ${ARG} "
  fi
done

CMDLINE="${CC} ${INCLUDEARGS} ${CFLAGS} ${CMDLINE} ${LINKARGS}"

echo "${CMDLINE}"
${CMDLINE}
echo rm -rf ${TMPDIR}
